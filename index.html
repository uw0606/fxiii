<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ‰ãƒ«å††ãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆã¨RSIã‚·ã‚°ãƒŠãƒ«</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- æ—¥æ™‚ç”¨ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- ãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>

  <!-- ç™»éŒ²å‡¦ç†ï¼ˆã“ã‚ŒãŒé‡è¦ï¼ï¼‰-->
  <script>
    const { CandlestickController, CandlestickElement, FinancialScale } = window['chartjs-chart-financial'];
    Chart.register(
      CandlestickController,
      CandlestickElement,
      FinancialScale,
      Chart.TimeScale,
      Chart.LinearScale,
      Chart.Tooltip,
      Chart.Legend
    );
  </script>

  <style>
    /* ã‚¹ã‚¿ã‚¤ãƒ«ã¯ã“ã“ã§OK */
    body {
      background-color: #1c1c1c;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      padding: 30px;
    }
    canvas {
      max-width: 800px;
      margin: auto;
      background-color: #fff;
      border-radius: 10px;
    }
    .card {
      background-color: #2e2e2e;
      padding: 30px;
      border-radius: 12px;
      display: inline-block;
      box-shadow: 0 0 15px rgba(255,255,255,0.1);
      margin-top: 20px;
    }
    .signal {
      font-size: 1.5rem;
      margin-top: 20px;
      font-weight: bold;
    }
    .buy {
      color: #00ff99;
    }
    .sell {
      color: #ff4d4d;
    }
    .wait {
      color: #cccccc;
    }
  </style>
</head>
<body>

  <h1>ãƒ‰ãƒ«å††ãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆã¨RSIã‚·ã‚°ãƒŠãƒ«</h1>
  <canvas id="candlestickChart" width="800" height="400"></canvas>

  <div class="card">
    <h2>ãƒ‰ãƒ«å††ãƒ¬ãƒ¼ãƒˆï¼ˆUSD/JPYï¼‰</h2>
    <p id="rate">å–å¾—ä¸­...</p>
    <p>RSI: <span id="rsi">-</span></p>
    <div id="signal" class="signal">åˆ¤å®šä¸­...</div>
  </div>

  <script>
    const ctx = document.getElementById('candlestickChart').getContext('2d');
    const candlestickChart = new Chart(ctx, {
      type: 'candlestick',
      data: {
        datasets: [{
          label: 'USD/JPY',
          data: []
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'minute'
            },
            ticks: {
              color: '#fff'
            }
          },
          y: {
            ticks: {
              color: '#fff'
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: '#fff'
            }
          }
        }
      }
    });

    // RSIè¨ˆç®—ç”¨ã®ã‚¯ãƒ­ãƒ¼ã‚ºä¾¡æ ¼é…åˆ—
    const closePrices = [];

    // RSIã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
    function calculateRSI(prices, period = 14) {
      if (prices.length < period + 1) return null;
      let gains = 0;
      let losses = 0;
      for (let i = prices.length - period; i < prices.length; i++) {
        const diff = prices[i] - prices[i - 1];
        if (diff >= 0) {
          gains += diff;
        } else {
          losses -= diff;
        }
      }
      const averageGain = gains / period;
      const averageLoss = losses / period;
      if (averageLoss === 0) return 100;
      const rs = averageGain / averageLoss;
      return 100 - (100 / (1 + rs));
    }

    // RSIã‚·ã‚°ãƒŠãƒ«ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateRSISignal(rsi) {
      const signalEl = document.getElementById("signal");
      const rsiEl = document.getElementById("rsi");
      rsiEl.textContent = rsi ? rsi.toFixed(2) : "-";
      signalEl.classList.remove("buy", "sell", "wait");
      if (rsi === null) {
        signalEl.textContent = "ãƒ‡ãƒ¼ã‚¿ä¸è¶³";
        signalEl.classList.add("wait");
      } else if (rsi < 30) {
        signalEl.textContent = "ğŸ’¡ è²·ã„ã®ãƒãƒ£ãƒ³ã‚¹ï¼";
        signalEl.classList.add("buy");
      } else if (rsi > 70) {
        signalEl.textContent = "âš ï¸ å£²ã‚Šã®ã‚µã‚¤ãƒ³ï¼";
        signalEl.classList.add("sell");
      } else {
        signalEl.textContent = "æ§˜å­è¦‹ï¼ˆä¸­ç«‹ï¼‰";
        signalEl.classList.add("wait");
      }
    }

    // åˆæœŸãƒ‡ãƒ¼ã‚¿è¿½åŠ ï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼‰
    for (let i = 0; i < 20; i++) {
      const now = new Date();
      now.setMinutes(now.getMinutes() - (20 - i));
      const open = 157 + Math.random();
      const close = open + (Math.random() - 0.5);
      const high = Math.max(open, close) + Math.random() * 0.5;
      const low = Math.min(open, close) - Math.random() * 0.5;
      candlestickChart.data.datasets[0].data.push({
        x: now,
        o: open,
        h: high,
        l: low,
        c: close
      });
      closePrices.push(close);
    }
    candlestickChart.update();

    // 10ç§’ã”ã¨ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    setInterval(() => {
      fetch('https://api.unirateapi.com/api/rates?api_key=h65qd0ij5fNu2TlJkWtzaiDSss70pXNVDHLYUTfrFjD2az8limCXMVBbaEf5BBZT&from=USD')
        .then(response => response.json())
        .then(data => {
          const rate = data.rates.JPY;
          const now = new Date();
          const fluctuation = (Math.random() - 0.5) * 0.2;
          const open = rate - 0.1;
          const close = rate;
          const high = rate + fluctuation;
          const low = rate - fluctuation;
          const newPoint = {
            x: now,
            o: open,
            h: high,
            l: low,
            c: close
          };
          candlestickChart.data.datasets[0].data.push(newPoint);
          if (candlestickChart.data.datasets[0].data.length > 20) {
            candlestickChart.data.datasets[0].data.shift();
          }
          candlestickChart.update();

          // ãƒ¬ãƒ¼ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
          document.getElementById("rate").textContent = rate.toFixed(2);

          // RSIè¨ˆç®—ã¨è¡¨ç¤º
          closePrices.push(close);
          if (closePrices.length > 100) {
            closePrices.shift();
          }
          const rsi = calculateRSI(closePrices);
          updateRSISignal(rsi);
        })
        .catch(err => {
          console.error("ç‚ºæ›¿ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:", err);
          document.getElementById("rate").textContent = "å–å¾—å¤±æ•—";
          updateRSISignal(null);
        });
    }, 10000);
  </script>

</body>
</html>
